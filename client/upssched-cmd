#! /bin/sh
#
# This script should be called by upssched via the CMDSCRIPT directive.
# 
# Here is a quick example to show how to handle a bunch of possible
# timer names with the help of the case structure.
#
# This script may be replaced with another program without harm.
#
# The first argument passed to your CMDSCRIPT is the name of the timer
# from your AT lines.

#case $1 in
#       onbattwarn)
#               # Send a notification mail
#               echo "The UPS has been on battery for awhile" \
#               | mail -s"UPS monitor" bofh@pager.example.com
#               # Create a flag-file on the filesystem, for your own processing
#               /usr/bin/touch /some/path/ups-on-battery
#               ;;
#       ups-back-on-power)
#               # Delete the flag-file on the filesystem
#               /bin/rm -f /some/path/ups-on-battery
#               ;;
#       upsgone)
#               logger -t upssched-cmd "The communication with UPS has been gone for awhile"
#               ;;
#       *)
#               logger -t upssched-cmd "Unrecognized command: $1"
#               ;;
#esac


# START: User-specific settings                            
# Use a user authorised to issue the commands below in upsd.users
UPS_USERNAME="xxxx"
UPS_PASSWORD="yyyy"
UPS_LINK="Eaton5Px@localhost"
# END  

case $1 in
    onbattwarn)
        # Send a notification mail
        echo "The UPS has been on battery for awhile" \
        | mail -s"UPS monitor" johan.vanderkolk@gmail.com
        # Create a flag-file on the filesystem, for your own processing
        /usr/bin/touch /home/johan/nutbat
         ;;

    onbatt)
        # make sure beeper is enabled
        upscmd -u ${UPS_USERNAME} -p ${UPS_PASSWORD} ${UPS_LINK} beeper.enable
        # alert
        message="Power outage, nu op de batterij"
        logger -t upssched-cmd "$message"
        ;;
    onpower)
        message="Power restored"
        logger -t upssched-cmd "$message"
        # wakeup NAS+backup in case they were shutdown and group1 was not shedded yet. (won't reboot as no power drop was detected)
        /usr/bin/WakeAll.sh
        ;;
    mute_beeper)
         message="(2) minute limit exceeded, muting beeper"
         upscmd -u ${UPS_USERNAME} -p ${UPS_PASSWORD} ${UPS_LINK} beeper.mute
         ;;
    onbatt_shutdown)
        message="Triggering shutdown after (20) minutes on battery"
        logger -t upssched-cmd "$message"
        # /sbin/upsmon -c fsd
        ;;
    replace_batt)
        message="Quick self-test indicates battery requires replacement"
        logger -t upssched-cmd "$message"
        ;;
    outlet_group1-off)
       message="Shedding group1"
       logger -t upssched-cmd "$message"
       upscmd -u ${UPS_USERNAME} -p ${UPS_PASSWORD} ${UPS_LINK} outlet.1.load.off

    *)
        logger -t upssched-cmd "Unrecognized command: $1"
        ;;
esac



